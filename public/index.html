<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>SE</title>

    <link rel="stylesheet" href="statics/lib/css/bootstrap.css">
    <link rel="stylesheet" href="statics/lib/css/toastr.css">
    <link rel="stylesheet" href="statics/app/css/style.css">

    <script src="statics/lib/js/jquery.min.js"></script>
    <script src="statics/lib/js/lodash.min.js"></script>
    <script src="statics/lib/js/bootstrap.min.js"></script>
    <script src="statics/lib/js/toastr.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="statics/lib/js/js-yaml.min.js"></script>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-md-6">
            team1: <span class="label label-default" id="team1-point">0</span>
            team2: <span class="label label-default" id="team2-point">0</span>
            <br>
            turn: <span class="label label-default" id="turn"></span>
            <br>
            game status: <span class="label label-default" id="game-status"></span>
            <br>

            <div id="views">views:</div>

            <div id="board"></div>
        </div>
        <div class="col-md-6">
            <pre id="output"></pre>
        </div>
    </div>
</div>
<script>
    var socket = io.connect();
    var view = null;
    socket.on('connect', function () {
        console.log('connect');
    });
    socket.on('map', function (data) {
        var $code = $('<code>').text('map:\n' + jsyaml.dump(data, null, 2));
        $('#output').prepend($code).prepend('\n');
    });

    function leave(oldView) {
        var $code = $('<code>').text('leaving ' + view);
        $('#output').prepend($code).prepend('\n');
        socket.emit('leave', oldView, function (data) {
            var $code = $('<code>').text('leave:\n' + jsyaml.dump(data, null, 2));
            $('#output').prepend($code).prepend('\n');
        });
    }

    function join(view) {
        var $code = $('<code>').text('join to ' + view);
        $('#output').prepend($code).prepend('\n');
        socket.emit('join', view, function (data) {
            $('#view').text(view);
            var $code = $('<code>').text('join:\n' + jsyaml.dump(data, null, 2));
            $('#output').prepend($code).prepend('\n');
        });
    }

    var joined = {};

    socket.on('info', function (data) {
        var $views = $('#views');
        $views.text('views: ');
        if (data.views) {
            view = data.views[0];
            _(data.views).each(function (view) {
                var $view = $('<span>')
                        .addClass('label')
                        .text(view)
                        .appendTo($views);

                if (joined[view]) {
                    $view.addClass('label-info');
                } else {
                    $view.addClass('label-default');
                }

                $views.append(' ');
                $view.on('click', function () {
                    if (joined[view]) {
                        $view.removeClass('label-info')
                                .addClass('label-default');
                    } else {
                        $view.removeClass('label-default')
                                .addClass('label-info');
                    }

                    if (joined[view]) {
                        leave(view);
                        joined[view] = false;
                    }
                    else {
                        join(view);
                        joined[view] = true;
                    }
                });
            });
        }
        var $code = $('<code>').text('info:\n' + jsyaml.dump(data, null, 2));
        $('#output').prepend($code).prepend('\n');
    });
    socket.on('diff', function (data) {
        var $code = $('<code>').text('diff:\n' + jsyaml.dump(data, null, 2));
        $('#output').prepend($code).prepend('\n');
    });
    var dynamics = {};
    socket.on('turn', function (turn, data) {
        $('#turn').text(turn);
        _(data.transients).each(function (item) {
            var div = $('<div>')
                    .css('left', item.position.x * 10)
                    .css('top', item.position.y * 10)
                    .attr('data-obj', item.type)
                    .appendTo('#board');
            div.hide({
                duration: item.duration * 1000,
                done: function () {
                    div.remove();
                }
            });

        });
        var di = _.indexBy(data.dynamics, 'id');
        _(dynamics).each(function (item, id) {
            if (di[id] == undefined) {
                item.$.remove();
            }
        });
        _(data.dynamics).each(function (item) {
            if (dynamics[item.id] == undefined) {
                dynamics[item.id] = _.cloneDeep(item);
                dynamics[item.id].$ = $('<div>').appendTo('#board');
            }
            dynamics[item.id].$
                    .css('left', item.position.x * 10)
                    .css('top', item.position.y * 10)
                    .attr('data-obj', item.type)
                    .appendTo('#board');
        });
        console.log(turn);
        console.log(data.dynamics);
    });
    socket.on('msgs', function (msgs) {
        _(msgs).each(function (msg) {
            toastr[msg.type](msg.text);
        });
        var $code = $('<code>').addClass('text-muted').text('msgs:\n' + jsyaml.dump(msgs, null, 2));
        $('#output').prepend($code).prepend('\n');
    });
    socket.on('status', function (status) {
        if (!(status.points && status.connections)) {
            return;
        }
        var $code = $('<code>').addClass('text-muted').text('status:\n' + jsyaml.dump(status, null, 2));
        $('#output').prepend($code).prepend('\n');
        $('#game-status')
                .text(status.gameStatus);
        $('#team1-point')
                .text(status.points.team1)
                .toggleClass('label-success', status.connections.team1)
                .toggleClass('label-default', !status.connections.team1);
        $('#team2-point')
                .text(status.points.team2)
                .toggleClass('label-success', status.connections.team2)
                .toggleClass('label-default', !status.connections.team2);
    });
</script>
</body>
</html>